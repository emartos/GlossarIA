---
import Layout from '../layouts/Layout.astro';
import LangSwitcher from '../components/LangSwitcher.astro';
import SearchBar from '../components/SearchBar.astro';
import TermList from '../components/TermList.astro';
import { t } from '../utils/translations';
import fs from 'fs';
import path from 'path';

const url = Astro.url;
const lang = (url.searchParams.get('lang') ?? 'es') as 'es' | 'en';
const q = (url.searchParams.get('q') ?? '').toLowerCase();
const levelFilter = url.searchParams.get('level') ?? '';

console.log('[GlossarIA] q =', q, 'level =', levelFilter);

// Read JSON file directly from the file system during build time
const jsonPath = path.join(process.cwd(), 'public', 'data', `glossary.${lang}.json`);
const jsonContent = fs.readFileSync(jsonPath, 'utf8');
const allTerms = JSON.parse(jsonContent) as any[];

const filtered = allTerms
  .filter((t) => {
    const matchesQuery =
      !q ||
      t.term.toLowerCase().includes(q) ||
      (t.short || '').toLowerCase().includes(q) ||
      (t.long || '').toLowerCase().includes(q);
    const matchesLevel = !levelFilter || t.level === levelFilter;
    return matchesQuery && matchesLevel;
  })
  .sort((a, b) => a.term.localeCompare(b.term, lang, { sensitivity: 'base' }));
---

<Layout title="GlossarIA Â· AI glossary" lang={lang}>
  <section
    style="display:flex;flex-direction:column;gap:1rem;margin-bottom:1.5rem;margin-top:0.5rem;"
  >
    <div style="display:flex;justify-content:space-between;gap:1rem;align-items:flex-start;">
      <div>
        <h1 style="margin:0 0 0.4rem;font-size:1.8rem;">
          {t('title', lang)}
        </h1>
        <p style="margin:0;color:var(--muted);max-width:540px;font-size:1.05rem;">
          {t('description', lang)}
        </p>
      </div>
      <div style="display:flex;gap:0.75rem;align-items:center;">
        <LangSwitcher />
      </div>
    </div>

    <SearchBar lang={lang} query={q} level={levelFilter} />
  </section>

  <section>
    <TermList terms={filtered} lang={lang} />
  </section>
</Layout>
